---
title: "Final Report"
subtitle: "due November 16, 2021 by 11:59 PM "
author: "The Gre8est Team: Roni Ochakovski, Matthew Wang, Judy Zhong"
date: "11/16/2021"
output: pdf_document
---

```{r load-packages, message = FALSE, warning = FALSE, echo = FALSE}
library(tidyverse) 
library(tidymodels)
library(infer)
library(ggplot2)
library(sf)
#install.packages("rnaturalearth")
library(rnaturalearth)
#install.packages("rnaturalearthdata")
library(rnaturalearthdata)
library(rgeos)
library(scales)
#install.packages("grid")
library(grid)
library(gridExtra)
knitr::opts_chunk$set(echo = FALSE)
``` 

```{r load-data, message = FALSE, warning = FALSE, echo=FALSE}
library(readr)
h_spend <- read_csv("../data/Health-Spending.CSV")
wb_tot_lifeexp <- read_csv("../data/World Bank Life Exp.csv")
wb_f_lifeexp <- read_csv("../data/World Bank Female Life Exp.csv")
wb_m_lifeexp <- read_csv("../data/World Bank Male Life Exp.csv")
# econ <- read_csv("../data/EconMetrics.csv")
# econ <- select(econ, -4)
misc_data <- read_csv("../data/World Bank Data.csv")
misc_data <- select(misc_data, -4)
```

```{r combine-lifeexp-data, warning = FALSE, echo=FALSE}
wb_tot_lifeexp_long <- pivot_longer(wb_tot_lifeexp, cols = "1990":"2020", names_to = "Year", values_to = "Total Life Expectancy")

wb_f_lifeexp_long <- wb_f_lifeexp %>%
  select(c(1:2,34:64)) %>%
  pivot_longer(cols = "1990":"2020", names_to = "Year", values_to = "Female Life Expectancy")

wb_m_lifeexp_long <- wb_m_lifeexp %>%
  select(c(1:2,34:64)) %>%
  pivot_longer(cols = "1990":"2020", names_to = "Year", values_to = "Male Life Expectancy")

lifeexp <- left_join(wb_tot_lifeexp_long, wb_f_lifeexp_long, by = c("Country Name", "Country Code", "Year"))

lifeexp <- left_join(lifeexp, wb_m_lifeexp_long, by = c("Country Name", "Country Code", "Year"))
```

```{r edit_misc_data, warning = FALSE, echo = FALSE}
yrs <- c(2011:2020)

colnames(misc_data) <- c("Country Name", "Country Code", "Series Name", yrs)
misc_temp <- misc_data %>%
  pivot_longer(cols = 4:13, names_to = "Year", values_to = "Value")
misc_temp2 <- misc_temp %>%
  group_by("Country Name") %>%
  pivot_wider(names_from = "Series Name", values_from = "Value") %>%
  ungroup()
misc_temp3 <- select(misc_temp2, -4, -18)
misc_data2 <- misc_temp3[-c(2171:2610),]
j <- c(4:16)
misc_data2[j] <- lapply(misc_data2[j], unlist)
misc_data2[j] <- lapply(misc_data2[j], as.numeric)
```

```{r edit_h_spend, warning = FALSE, echo=FALSE}
h_spend2 <- select(h_spend, -1, -4)[-c(4897:5232),]
h_spend2 <- h_spend2 %>%
   mutate(location_name = case_when(
       location_name == "United States of America" ~ "United States",
       TRUE ~ location_name))
colnames(h_spend2)[1:3] <- c("Country Name", "Country Code", "Year")
```

```{r combine_data, warning = FALSE, echo=FALSE}
full_data <- full_join(lifeexp, misc_data2, by = c("Country Name", "Country Code", "Year"))
full_data$Year = as.double(full_data$Year)
full_data <- full_join(full_data, h_spend2, by = c("Country Name", "Country Code", "Year"))
full_data$`Total Life Expectancy` = as.numeric(full_data$`Total Life Expectancy`)
```

# Background
Numerous studies have analyzed the correlation between health spending and health outcomes, consistently finding a positive relationship between the two [1]. Other studies have investigated how GDP and educational attainment are associated with health outcomes and found that both are positive predictors of health [2]. Our study looks to build on past findings and conduct a multivariate analysis to better inform global leaders on focus areas for improving global health.

Like similar studies, we have chosen to analyze life expectancy and under-5 mortality rate as measures of health [1]. Period life expectancy at birth is often used as a measure of the overall health of a population. It is derived from the probabilities of people of certain age groups dying given the mortality rates of those age groups over a specific time frame. The probabilities are then used in a survival function to project the average age of death of a newborn of that time period [3]. Meanwhile, under-5 mortality rate reflects the probability of a child born in the year in question dying before the age of 5. It is represented as the number of predicted deaths per 1,000 live births [4].

# Research Question
This analysis aims to determine the significance of relationships between a set of World Development Indicators and health outcomes, measured by life expectancy and under-5 mortality rate.

# Data
We are combining health spending data from the Global Health Data Exchange [5] and world economic/health-related data from the World Bank [6], ranging from 1990-2020. For these data sets, we will be analyzing data from the 204 countries and territories that are included in both databases. The health spending data was collected from a wide variety of sources that included program reports, budget data, national estimates, and National Health Accounts (NHAs). The variables that we are most concerned with are location ID, location name, year, and total health expenditure (THE) per capita in purchasing power parity (PPP) dollars (2020 USD). Purchasing power parity accounts for the differences in economic and standards of living between countries. The World Bank collects data through various sources, mostly through national statistical systems of member countries. The variables that we are most concerned with are country or area, total life expectancy at birth (years), male life expectancy at birth (years), female life expectancy at birth (years), GDP (current US dollars), GDP growth (annual %), income share held by lowest 20%, mortality rate under 5 (per 1,000 live births), poverty headcount ratio at national poverty lines (% of population), and educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative) [6].

# Descriptive Stats
Following the data-cleaning, we ran some descriptive statistics to visualize the data. The first thing we noticed was that healthcare spending variation was extremely large across countries. To standardize the numbers across countries, we attempted to look at just the healthcare spending per person, but even that yielded huge variation across countries:

```{r healthcarespenindsummarystat, warning = FALSE, echo = FALSE}
full_data %>%
  select(the_per_cap_ppp_mean) %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  summary(the_per_cap_ppp_mean)
```
As you can see, the quartiles have enormous range between them. To standardize and reduce variation further, we took the log of the spending per person, and got an approximately normal distribution of healthcare spending across countries. We followed the same procedure to normalize mortality rate, healthcare spending, and GDP. We did so to satisfy any future assumptions given our relatively small sample size. The approximately normal distributions are shown below:

```{r outcome-histo, warning = FALSE, echo=FALSE, fig.height = 2}
p_lifeexp <- full_data %>%
  ggplot(aes(full_data$'Total Life Expectancy')) + 
  geom_histogram(fill = "blue", na.rm = TRUE, bins = 50) + 
  labs(
    x = "Life Expectancy (Years)",
    y = "Frequency",
    title = "Distribution of Life Expectancy"
  ) 

p_fert <- full_data %>%
  ggplot(aes(full_data$'Fertility rate, total (births per woman)')) + 
  geom_histogram(fill = "blue", na.rm = TRUE, bins = 50) + 
  labs(
    x = "Fertility Rate (Births per Woman)",
    y = "Frequency",
    title = "Distribution of Fertility Rate"
  ) 

p_log_fert <- full_data %>%
  ggplot(aes((log(full_data$'Fertility rate, total (births per woman)')))) + 
  geom_histogram(fill = "blue", na.rm = TRUE, bins = 50) + 
  labs(
    x = "Fertility Rate (Log of Births per Woman)",
    y = "Frequency",
    title = "Fertility Rate"
  )

p_mort <- full_data %>%
  ggplot(aes(full_data$`Mortality rate, under-5 (per 1,000 live births)`)) + 
  geom_histogram(fill = "blue", na.rm = TRUE, bins = 50) + 
  labs(
    x = "Mortality Rate (per 1,000 Live Births)",
    y = "Frequency",
    title = "Mortality Rate"
  )

p_log_mort <- full_data %>%
  ggplot(aes(log(full_data$`Mortality rate, under-5 (per 1,000 live births)`))) + 
  geom_histogram(fill = "aquamarine", na.rm = TRUE, bins = 50) + 
  labs(
    x = "Mortality Rate (Log per 1,000 Live Births)",
    y = "Frequency",
    title = "Distribution of Mortality Rate"
  )
grid.arrange(grobs = list(p_lifeexp, p_log_mort), ncol = 2)
```

```{r healtcarespendinghisto, warning = FALSE, echo=FALSE, fig.height = 4}
p_the <- full_data %>%
  ggplot(aes(x = the_per_cap_ppp_mean)) + 
  geom_histogram(fill = "red", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Mean Total Health Spending per Person (in PPP dollars)",
    y = "Frequency",
    title = "Distribution of Health Care Spending"
  )

p_log_the <- full_data %>%
  ggplot(aes(x = log(the_per_cap_ppp_mean))) + 
  geom_histogram(fill = "red", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Log Mean THE per Capita (Log PPP dollars)",
    y = "Frequency",
    title = "Health Care Spending"
  ) +
  theme(title = element_text(size = 10),
        axis.title.x = element_text(size = 6),
        axis.title.y = element_text(size = 8))

p_log_pov <- full_data %>%
  ggplot(aes(log(full_data$`Poverty headcount ratio at national poverty lines (% of population)`))) + 
  geom_histogram(fill = "blue", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Log Poverty Headcount Ratio",
    y = "Frequency",
    title = "Poverty Headcount"
  )

p_pov <- full_data %>%
  ggplot(aes(full_data$`Poverty headcount ratio at national poverty lines (% of population)`)) + 
  geom_histogram(fill = "maroon1", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Poverty Headcount Ratio",
    y = "Frequency",
    title = "Poverty Headcount"
  ) +
  theme(axis.title.y = element_text(size = 8))

p_log_gdp <- full_data %>%
  ggplot(aes(log(full_data$`GDP per capita (current US$)`))) + 
  geom_histogram(fill = "darkorange", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Log GDP",
    y = "Frequency",
    title = "GDP"
  ) +
  theme(axis.title.y = element_text(size = 8))

p_gdpg <- full_data %>%
  ggplot(aes(log(full_data$`GDP per capita growth (annual %)`))) + 
  geom_histogram(fill = "darkgoldenrod2", na.rm = TRUE, bins = 30) + 
  labs(
    x = "GDP Growth (Annual %)",
    y = "Frequency",
    title = "GDP Growth"
  ) +
  theme(axis.title.y = element_text(size = 8))

p_inc <- full_data %>%
  ggplot(aes(full_data$`Income share held by lowest 20%`)) + 
  geom_histogram(fill = "purple", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Income Share Held by Lowest 20%",
    y = "Frequency",
    title = "Income Share (%)"
  ) +
  theme(axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8))

p_edu <- ggplot(data = full_data, aes(full_data$`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`)) + 
  geom_histogram(fill = "yellow", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Secondary Education Completion (%)",
    y = "Frequency",
    title = "Secondary Educational Attainment"
  ) +
  theme(title = element_text(size = 6),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8))

grid.arrange(grobs = list(p_log_the, p_log_gdp, p_gdpg, p_pov, p_inc, p_edu), ncol = 3)
```

Then, we looked at healthcare spending over time in a few selected countries to see any trends in the data:

```{r healthspendinglinegraph, warning =FALSE, echo=FALSE, fig.height = 3, fig.width = 4}
full_data %>%
  filter(`Country Name` == "Australia" | `Country Name` == "United States of America" |  `Country Name` == "Canada" |  `Country Name` == "China" | `Country Name` == "Indonesia" | `Country Name` == "Russia" | `Country Name` == "Sudan") %>%
ggplot(aes(x=Year, y=log(the_per_cap_ppp_mean), group = `Country Name`)) +
  geom_line(aes(linetype= `Country Name`))+
  geom_point(aes(shape=`Country Name`)) +
 labs( 
   title = "Health Spending Around the World Over Time",
       y = "Log of Mean total health spending per person (in PPP dollars)")
```

We found that healthcare spending generally increased over time in developed countries and was also significantly larger in Western than Eastern countries. This would be confirmed when we mapped health care spending. While mapping, we also mapped what would later be one of our response variables: life expectancy. We wanted to visualize life expectancy across countries to see any geographic patterns:

```{r healthspending_and_lifeexpectancymap, warning =FALSE, echo=FALSE, fig.width=10, fig.height = 3}

world <- ne_countries(scale = "medium", returnclass = "sf")
full_data1 = full_data %>%
  filter(Year == 2015)
healthspending.world <- merge(world, full_data1, by.x="adm0_a3", by.y="Country Code")

ggplot(data = healthspending.world) +
    geom_sf(aes(fill = log(the_per_cap_ppp_mean))) +
    scale_fill_viridis_c(option = "plasma") +
    labs(x = "Longitude",
       y = "Latitude",
       title = "Health Spending Around the World",
       fill = "Log of Mean THE per Capita (in PPP dollars)")

ggplot(data = healthspending.world) +
    geom_sf(aes(fill = log(`Mortality rate, under-5 (per 1,000 live births)`))) +
    scale_fill_viridis_c(option = "plasma") +
    labs(x = "Longitude",
       y = "Latitude",
       title = "Mortality Rates Around the World",
       fill = "Log Mortality Rates Under 5")

ggplot(data = healthspending.world) +
    geom_sf(aes(fill = `Total Life Expectancy`)) +
    scale_fill_viridis_c(option = "plasma") +
    labs(x = "Longitude",
       y = "Latitude",
       title = "Life Expectancies Around the World",
       fill = "Life Expectancy")
```
We saw the same pattern as in the line charts where Western countries had higher healthcare spending,higher life expectancy, and lower mortality rates. The same trend was generally true for developed compared to non-developed regions. We also began to notice the problem of missingness in our dataset where mortality rates and life expectancies for some countries (most notably the U.S.) were absent.

Finally, we wanted to visualize the relationship between healthcare spending and our health outcomes (being mortality rates under 5 and life expectancy). We used scatterplots to do so:
```{r healthspending_vs_lifeeexpectancy, warning =FALSE, echo=FALSE, fig.height = 3}
full_data1 %>%
ggplot(aes(x = log(the_per_cap_ppp_mean), y = `Total Life Expectancy`)) + 
  geom_point(alpha = 0.6) +
labs( x= "Log of Mean THE per Capita (in PPP dollars)",
      y = "Total Life Expectancy",
      title = "Mean THE per Capita versus Life Expectancy")

full_data1 %>%
ggplot(aes(x = log(the_per_cap_ppp_mean), y = `Mortality rate, under-5 (per 1,000 live births)`)) + 
  geom_point(alpha = 0.6) +
labs( x= "Log of Mean THE per Capita (in PPP dollars)", y = "Mortality Rates Under 5")
```
There is a clear positive linear relationship between healthcare spending and life expectancy but a more exponential-decay trend in healthcare spending and mortality rates under 5. Viewing these trends would come in helpful when modelling. Within the descriptive statistics portion of our project, we also explored healthcare spending by GDP, distributions of mortality rates, life expectancies, and fertility rates, male vs. female life expectancy distributions, and line graphs of health outcomes over time. However, the most significant graphs and visualizations are included above as these helped the most in understanding our data set and fitting the proper models. In addition to this, some outcomes such as fertility rates were excluded after data visualization due the missingness in that variable being to great to deal with. 

# Modelling

In our models, we decided to explore two commonly used health outcome measures: life expectancy and mortality rate under the age of 5. For each health outcome, we constructed 3 different models: a simple linear model with all the covariates we had identified, a quadratic model with only the covariates that increased adjusted R^2, and a quadratic model with interaction effects using only the covariates that increased adjusted R^2. Adjusted R^2 and residual plots were used for assessing and selecting models. 

**Life Expectancy Simple Linear Model**

Total Life Expectancy = 54.01077793 + 4.32153666[log(THE per capita in PPP dollars)] - 0.08676898[log(GDP)] - 0.07137130[GDP growth] - 0.23274026[Income share held by lowest 20%] - 0.10305518	[Poverty headcount ratio] - 0.04570412 [Educational attainment]

```{r full_life_expectancy_model_table, include = FALSE}

full_data_life_exp <- full_data %>%
  filter(is.na(`Total Life Expectancy`) == FALSE) %>%
  filter(`Total Life Expectancy` != '..') %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  filter(is.na(`GDP (current US$)`) == FALSE) %>%
  filter(is.na(`GDP growth (annual %)`) == FALSE) %>%
  filter(is.na(`Income share held by lowest 20%`) == FALSE) %>%
  filter(is.na(`Poverty headcount ratio at national poverty lines (% of population)`) == FALSE) %>%
  filter(is.na(`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`) == FALSE)

lifeexp_fullfit <- linear_reg() %>%
 set_engine("lm") %>%
fit(`Total Life Expectancy` ~ log(the_per_cap_ppp_mean) +  log(`GDP (current US$)`) +`GDP growth (annual %)` + `Income share held by lowest 20%` + `Poverty headcount ratio at national poverty lines (% of population)` + `Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`, data = full_data_life_exp)

tidy(lifeexp_fullfit, conf.int=TRUE)
```


``` {r full_life_expectancy_model_r2, include = FALSE}
glance(lifeexp_fullfit)$r.squared
glance(lifeexp_fullfit)$adj.r.squared
```

The R^2 for the life expectancy simple linear model is 0.8387499 which means that 0.8387499 of the variation in life expectancy is explained by the model. The adjusted R^2 for the life expectancy simple linear model is 0.8337108 which means that 0.8337108 of the variation in life expectancy is explained by the model, adjusting for the number of variables included. 

``` {r full_life_expectancy_model_resid, warning = FALSE, echo = FALSE, fig.height = 3, fig.width = 5}
lifeexp_fullfit_aug <- augment(lifeexp_fullfit$fit)

ggplot(lifeexp_fullfit_aug, mapping = aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Life Expectancy Simple Linear Model Residual Plot", x = "Predicted Total Life Expectancy (years)", y = "Residuals")
```
This residual scatter plot is concerning because the points in the plot appear to be create a curvy shape and thus are not randomly and evenly distributed around 0. There is also some clustering of the residual points occurring around 82.5 years in predicted total life expectancy. 

**Life Expectancy Quadratic Model**

Total Life Expectancy = 38.837594399 + 7.060190898[log(THE per capita in PPP dollars)] - 0.215246470[log(THE per capita in PPP dollars)]^2 - 0.131323652[log(GDP)] - 0.083085644[Poverty headcount ratio] + 0.190683904[Educational attainment] - 0.002025324[Educational attainment]^2

```{r sig_life_expectancy_model_table, include = FALSE}
sig_data_life_exp <- full_data %>%
  filter(is.na(`Total Life Expectancy`) == FALSE) %>%
  filter(`Total Life Expectancy` != '..') %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  filter(is.na(`GDP (current US$)`) == FALSE) %>%
  filter(is.na(`Poverty headcount ratio at national poverty lines (% of population)`) == FALSE) %>%
  filter(is.na(`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`) == FALSE) %>%
  
  mutate(spending = log(the_per_cap_ppp_mean)) %>%
  mutate(gdp = log(`GDP (current US$)`)) %>%
  mutate(poverty = `Poverty headcount ratio at national poverty lines (% of population)`) %>%
  mutate(education = `Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`)

sig_data_life_exp$spending2 <- sig_data_life_exp$spending^2
sig_data_life_exp$education2 <- sig_data_life_exp$education^2

lifeexp_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(`Total Life Expectancy` ~  
        spending 
      + spending2 
      + gdp
      + poverty
      + education 
      + education2
      ,data = sig_data_life_exp)

tidy(lifeexp_fit, conf.int=TRUE)
```

```{r sig_life_expectancy_model_table_r2, include = FALSE}
glance(lifeexp_fit)$r.squared
glance(lifeexp_fit)$adj.r.squared
```

The R^2 for the life expectancy quadratic model is 0.8997453 which means that 0.8997453 of the variation in life expectancy is explained by the model. The adjusted R^2 for the life expectancy quadratic model is 0.896811 which means that 0.896811 of the variation in life expectancy is explained by the model, adjusting for the number of variables included. The higher adjusted R^2 of this quadratic model indicates that it is a better model than the simple linear model. 

```{r sig_life_expectancy_model_table_resid, warning = FALSE, echo = FALSE, fig.width = 5, fig.height = 3}
lifeexp_fit_aug <- augment(lifeexp_fit$fit)

ggplot(lifeexp_fit_aug, mapping = aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Life Expectancy Quadratic Model Residual Plot", x = "Predicted Total Life Expectancy (years)", y = "Residuals")
```

This residual scatter plot is an improvement from the linear model as the points no longer create as distinct of a curvy shape and thus are more randomly and evenly distributed around 0. The residual points also seem to be more tightly centered/closer to 0. However, there still appears to be clustering around 82.5 predicted years as well as around 77.5 predicted years.

**Life Expectancy Quadratic Interaction Model**

Total Life Expectancy = 59.46 + -2.22[log(THE per capita in PPP dollars)] + 0.27[log(THE per capita in PPP dollars)]^2 + 0.46[log(GDP)] -0.18[poverty headcount ratio] + 0.46[educational attainment] -0.002[educational attainment]^2 -0.313[GDP growth] -0.00495[poverty headcount ratio * educational attainment] + 0.0059[educational attainment * GDP growth] -0.022[log(GDP) * poverty headcount ratio] -0.00597[log(GDP) * educational attainment] + 0.133[log(THE per capita in PPP dollars) * poverty headcount ratio]

From this model, of the significant and interpretable coefficients, we see that for every percent of the population that has completed at least secondary education, we expect to see life expectancy to be higher by 0.46 on average.

```{r mixed_life_expectancy_model_table, include = FALSE}
mixed_data_life_exp <- full_data %>%
  filter(is.na(`Total Life Expectancy`) == FALSE) %>%
  filter(`Total Life Expectancy` != '..') %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  filter(is.na(`GDP (current US$)`) == FALSE) %>%
  filter(is.na(`GDP growth (annual %)`) == FALSE) %>%
  filter(is.na(`Poverty headcount ratio at national poverty lines (% of population)`) == FALSE) %>%
  filter(is.na(`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`) == FALSE) %>%
  
  mutate(spending = log(the_per_cap_ppp_mean)) %>%
  mutate(gdp = log(`GDP (current US$)`)) %>%
  mutate(gdpg = `GDP growth (annual %)`) %>%
  mutate(poverty = `Poverty headcount ratio at national poverty lines (% of population)`) %>%
  mutate(education = `Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`)

mixed_data_life_exp$spending2 <- mixed_data_life_exp$spending^2
mixed_data_life_exp$education2 <- mixed_data_life_exp$education^2

lifeexp_mixedfit<- linear_reg() %>%
  set_engine("lm") %>%
  fit(`Total Life Expectancy` ~  
        spending 
      + spending2 
      + gdp
      + poverty
      + education 
      + education2
      + poverty*education
      + gdpg*education
      + gdp*poverty
      + gdp*education
      + spending*poverty
      ,data = mixed_data_life_exp)

tidy(lifeexp_mixedfit, conf.int=TRUE)
```

```{r mixed_life_expectancy_model_r2, include = FALSE}
glance(lifeexp_mixedfit)$r.squared
glance(lifeexp_mixedfit)$adj.r.squared
```

The R^2 for the life expectancy quadratic interaction model is 0.9203884 which means that 0.9203884 of the variation in life expectancy is explained by the model. The adjusted R^2 for the life expectancy quadratic interaction model is 0.9155877 which means that 0.9155877 of the variation in life expectancy is explained by the model, adjusting for the number of variables included. The higher adjusted R^2 of this quadratic interaction model indicates that it is a better model than the simple linear model and quadratic model. 

```{r mixed_life_expectancy_model_resid, warning = FALSE, echo = FALSE, fig.height = 3, fig.width = 5}
lifeexp_mixedfit_aug <- augment(lifeexp_mixedfit$fit)

ggplot(lifeexp_mixedfit_aug, mapping = aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Life Expectancy Quadratic Interaction Model Residual Plot", x = "Predicted Total Life Expectancy (years)", y = "Residuals")
```

This residual scatter plot is an improvement from the quadratic model as the points are appear to less clustered and thus are more evenly distributed across the predicted years. However, the residual points seem to be less tightly centered/close to 0.

**Mortality Rate Under the Age of 5 Simple Linear Model**

log(Mortality Rate Under the Age of 5) = 4.629698850 - 0.584672973[log(THE per capita in PPP dollars)] + 0.072586447[log(GDP)] + 0.046301152[GDP growth] - 0.010565241[Income share held by lowest 20%] + 0.010933283[Poverty headcount ratio] - 0.007591069[Educational attainment]

```{r full_mortality_model_table, include = FALSE}
full_data_mortality <- full_data %>%
  filter(is.na(`Mortality rate, under-5 (per 1,000 live births)`) == FALSE) %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  filter(is.na(`GDP (current US$)`) == FALSE) %>%
  filter(is.na(`GDP growth (annual %)`) == FALSE) %>%
  filter(is.na(`Income share held by lowest 20%`) == FALSE) %>%
  filter(is.na(`Poverty headcount ratio at national poverty lines (% of population)`) == FALSE) %>%
  filter(is.na(`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`) == FALSE)
  
mortality_fullfit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(log(`Mortality rate, under-5 (per 1,000 live births)`) ~ log(the_per_cap_ppp_mean) + log(`GDP (current US$)`) + `GDP growth (annual %)` + `Income share held by lowest 20%` + `Poverty headcount ratio at national poverty lines (% of population)` + `Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`, data = full_data_mortality)

tidy(mortality_fullfit, conf.int=TRUE)
```

```{r full_mortality_model_r2, include = FALSE}
glance(mortality_fullfit)$r.squared
glance(mortality_fullfit)$adj.r.squared
```

The R^2 for the mortality rate under the age of 5 simple linear model is 0.8513467 which means that 0.8513467 of the variation in mortality rate is explained by the model. The adjusted R^2 for the mortality rate under the age of 5 simple linear model is 0.8467013 which means that 0.8467013 of the variation in mortality rate is explained by the model, adjusting for the number of variables included.

```{r full_mortality_model_resid, warning = FALSE, echo = FALSE, fig.height = 3, fig.width = 5}
mortality_fullfit_aug <- augment(mortality_fullfit$fit)

ggplot(mortality_fullfit_aug, mapping = aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Mortality Rate Under the Age of 5 Simple Linear Model Residual Plot", x = "Predicted Mortality Rate, under-5 (per 1,000 live births)", y = "Residuals")
```

This residual scatter plot is concerning because the points in the plot appear to be clustered around the lower predicted mortality rates (1-2 range) and thus are not evenly distributed. There is also some curvy shape/pattern that is being formed by the residual points, suggesting that the residuals are not randomly distributed around 0. 

**Mortality Rate Under the Age of 5 Quadratic Model**

log(Mortality Rate Under the Age of 5) = 23.4435649786 - 2.5355361915[log(THE per capita in PPP dollars)] + 0.1360493432[log(THE per capita in PPP dollars)]^2 - 0.5448553694[log(GDP)] + 0.0115264717[log(GDP)]^2 - 0.7721845449[Income share] + 0.0459322976[Income share]^2 - 0.0002119304[Poverty headcount ratio]^2 - 0.0267254803[Educational attainment] + 0.0001907620[Educational attainment]^2

```{r sig_mortality_model_table, include = FALSE}
sig_data_mortality <- full_data %>%
  filter(is.na(`Mortality rate, under-5 (per 1,000 live births)`) == FALSE) %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  filter(is.na(`GDP (current US$)`) == FALSE) %>%
  filter(is.na(`Income share held by lowest 20%`) == FALSE) %>%
  filter(is.na(`Poverty headcount ratio at national poverty lines (% of population)`) == FALSE) %>%
  filter(is.na(`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`) == FALSE) %>%
  
  mutate(mortality = log(`Mortality rate, under-5 (per 1,000 live births)`)) %>%
  mutate(spending = log(the_per_cap_ppp_mean)) %>%
  mutate(gdp = log(`GDP (current US$)`)) %>%
  mutate(income = `Income share held by lowest 20%`) %>%
  mutate(poverty = `Poverty headcount ratio at national poverty lines (% of population)`) %>%
  mutate(education = `Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`)

sig_data_mortality$spending2 <- sig_data_mortality$spending^2
sig_data_mortality$gdp2 <- sig_data_mortality$gdp^2
sig_data_mortality$income2 <- sig_data_mortality$income^2
sig_data_mortality$poverty2 <- sig_data_mortality$poverty^2
sig_data_mortality$education2 <- sig_data_mortality$education^2

mortality_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(mortality ~  spending 
      + spending2
      + gdp
      + gdp2
      + income
      + income2
      + poverty2
      + education
      + education2
      ,data = sig_data_mortality)

tidy(mortality_fit, conf.int=TRUE)
```

```{r sig_mortality_model_r2, include = FALSE}
glance(mortality_fit)$r.squared
glance(mortality_fit)$adj.r.squared
```

The R^2 for the mortality rate under the age of 5 quadratic model is 0.8789936 which means that 0.8789936 of the variation in mortality rate is explained by the model. The adjusted R^2 for the mortality rate under the age of 5 quadratic model is 0.8732314 which means that 0.8732314 of the variation in mortality rate is explained by the model, adjusting for the number of variables included. The higher adjusted R^2 of this quadratic model indicates that it is a better model than the simple linear model. 

```{r sig_mortality_model_resid, warning = FALSE, echo = FALSE, fig.height = 3, fig.width = 5}
mortality_fit_aug <- augment(mortality_fit$fit)

ggplot(mortality_fit_aug, mapping = aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Mortality Rate Under the Age of 5 Quadratic Model Residual Plot", x = "Predicted Mortality Rate, under-5 (per 1,000 live births)", y = "Residuals")
```

This residual scatter plot is a slight improvement from the linear model as the curvy shape of the points is less distinct and thus the residual points are more randomly and evenly distributed around 0. However, there still appears to be clustering around the lower predicted mortality rates (1-2 range).

**Mortality Rate Under the Age of 5 Quadratic Interaction Model**

log(Mortality Rate Under the Age of 5) = 24.2 + -0.17[log(THE per capita in PPP dollars)] + 0.12[log(THE per capita in PPP dollars)]^2 - 1.3[log(GDP)] + 0.0041[log(GDP)]^2 - 0.16[income share] + 0.0069[income share]^2 + 0.00052[poverty head count ratio]^2 -0.113[educational attainment] + 0.000328[educational attainment]^2 -0.0796[poverty head count ratio] -.0019[income share * educational attainment] -0.079[log(THE per capita in PPP dollars) * log(GDP)] + 0.0034[log(GDP) * educational attainment] -0.0415[log(GDP) * income share] + 0.0073[income share * poverty head count ratio]

For this model, of the significant and interpretable coefficients, as the percent of the population with post-secondary education increased by 1 percent, we would expect the mortaly rate under the age of 5 to decrease by 0.11, on average. In addition to that, as poverty head count ratio increases by one, we expect the mortality rate under the age of 5 to decrease by 0.0796. 

```{r mixed_mortality_model_table, include = FALSE}
mixed_data_mortality <- full_data %>%
  filter(is.na(`Mortality rate, under-5 (per 1,000 live births)`) == FALSE) %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  filter(is.na(`GDP (current US$)`) == FALSE) %>%
  filter(is.na(`GDP growth (annual %)`) == FALSE) %>%
  filter(is.na(`Income share held by lowest 20%`) == FALSE) %>%
  filter(is.na(`Poverty headcount ratio at national poverty lines (% of population)`) == FALSE) %>%
  filter(is.na(`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`) == FALSE) %>%
  
  mutate(mortality = log(`Mortality rate, under-5 (per 1,000 live births)`)) %>%
  mutate(spending = log(the_per_cap_ppp_mean)) %>%
  mutate(gdp = log(`GDP (current US$)`)) %>%
  mutate(gdpg = `GDP (current US$)`) %>%
  mutate(income = `Income share held by lowest 20%`) %>%
  mutate(poverty = `Poverty headcount ratio at national poverty lines (% of population)`) %>%
  mutate(education = `Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`)

mixed_data_mortality$spending2 <- mixed_data_mortality$spending^2
mixed_data_mortality$gdp2 <- mixed_data_mortality$gdp^2
mixed_data_mortality$income2 <- mixed_data_mortality$income^2
mixed_data_mortality$poverty2 <- mixed_data_mortality$poverty^2
mixed_data_mortality$education2 <- mixed_data_mortality$education^2

mortality_mixedfit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(mortality ~  spending 
      + spending2
      + gdp
      + gdp2
      + income
      + income2
      + poverty2
      + education
      + education2
      + income*education
      + spending*gdp
      + gdpg*income
      + gdpg*education
      + gdp*education
      + gdp*income
      + income*poverty
      ,data = mixed_data_mortality)

tidy(mortality_mixedfit, conf.int=TRUE)
```


```{r mixed_mortality_model_r2, include = FALSE}
glance(mortality_mixedfit)$r.squared
glance(mortality_mixedfit)$adj.r.squared
```

The R^2 for the mortality rate under the age of 5 quadratic interaction model is 0.9123402 which means that 0.9123402 of the variation in mortality rate is explained by the model. The adjusted R^2 for the mortality rate under the age of 5 quadratic interaction model is 0.9035743 which means that 0.9035743 of the variation in mortality rate is explained by the model, adjusting for the number of variables included. The higher adjusted R^2 of this quadratic interaction model indicates that it is a better model than the simple linear model and quadratic model. 

```{r mixed_mortality_model_resid, warning = FALSE, echo = FALSE, fig.height = 3, fig.width = 5}
mortality_mixedfit_aug <- augment(mortality_mixedfit$fit)

ggplot(mortality_mixedfit_aug, mapping = aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Mortality Rate Under the Age of 5 Quadratic Interaction Model Residual Plot", x = "Predicted Mortality Rate, under-5 (per 1,000 live births)", y = "Residuals")
```

This residual scatter plot is an improvement from the quadratic model as the points are appear to less clustered and thus are more evenly distributed across predicted mortality rates. The curvy shape of the residual points is also less prominent in this plot. However, the points seem to be less tightly centered/close to 0.

# Conclusions
Comparing the two final models, we see one major similarity arise, whether we use mortality rates under 5 or life expectancy. As the percent of the population that has post-secondary education increases, health outcomes are expected to improve, on average. Therefore, the most significant and consistent conclusion we can take away is that there appears to be an association between educational levels in a country and their health outcomes. 

# Limitations
One limitation in our models is that although some of the interaction terms and normalized variables improved the models, their coefficients proved to be uninterpretable. In addition to that, the residual plot for the Life Expectancy Quadratic Interaction Model which we used for analysis had some clustering which was not ideal. The clustering was not extreme and the R^2 was high enough to justify use of the model. 

# References
 [1] Gallet CA, Doucouliagos H. The impact of healthcare spending on health outcomes: A meta-regression analysis. Soc Sci Med. 2017 Apr;179:9-17. doi: 10.1016/j.socscimed.2017.02.024. Epub 2017 Feb 20. PMID: 28237460.
 [2] Lutz, Wolfgang and Endale Kebede. "Education and Health: Redrawing the Preston Curve." Population and Development Review, vol. 44, no. 2, 2018, pp. 343-61, doi:https://doi.org/10.1111/padr.12141.
 [3] Luy, Marc et al. "Life Expectancy: Frequently Used, but Hardly Understood." Gerontology, vol. 66, no. 1, 2019, pp. 95-104, https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7026938/.
 [4] "Under-Five Mortality Rate (Probability of Dying by Age 5 Per 1000 Live Births)." Indicator Metadata Registry List. World Health Organization https://www.who.int/data/gho/indicator-metadata-registry/imr-details/7.
 [5] [1] Global Burden of Disease Collaborative Network. Global Health Spending 1995-2018. Seattle, United States of America: Institute for Health Metrics and Evaluation (IHME), 2021. \