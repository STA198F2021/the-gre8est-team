---
title: "Final Report"
subtitle: "due November 16, 2021 by 11:59 PM "
author: "The Gre8est Team: Roni Ochakovski, Matthew Wang, Judy Zhong"
date: "11/16/2021"
output: pdf_document
fontsize: 10pt
---

```{r load-packages, message = FALSE, warning = FALSE, echo = FALSE}
library(tidyverse) 
library(tidymodels)
library(infer)
library(ggplot2)
library(sf)
#install.packages("rnaturalearth")
library(rnaturalearth)
#install.packages("rnaturalearthdata")
library(rnaturalearthdata)
library(rgeos)
library(scales)
#install.packages("grid")
library(grid)
library(gridExtra)
#install.packages("kableExtra")
library(kableExtra)
knitr::opts_chunk$set(echo = FALSE)
``` 

```{r load-data, message = FALSE, warning = FALSE, echo=FALSE}
library(readr)
h_spend <- read_csv("../data/Health-Spending.CSV")
wb_tot_lifeexp <- read_csv("../data/World Bank Life Exp.csv")
wb_f_lifeexp <- read_csv("../data/World Bank Female Life Exp.csv")
wb_m_lifeexp <- read_csv("../data/World Bank Male Life Exp.csv")
# econ <- read_csv("../data/EconMetrics.csv")
# econ <- select(econ, -4)
misc_data <- read_csv("../data/World Bank Data.csv")
misc_data <- select(misc_data, -4)
```

```{r combine-lifeexp-data, warning = FALSE, echo=FALSE}
wb_tot_lifeexp_long <- pivot_longer(wb_tot_lifeexp, cols = "1990":"2020", names_to = "Year", values_to = "Total Life Expectancy")

wb_f_lifeexp_long <- wb_f_lifeexp %>%
  select(c(1:2,34:64)) %>%
  pivot_longer(cols = "1990":"2020", names_to = "Year", values_to = "Female Life Expectancy")

wb_m_lifeexp_long <- wb_m_lifeexp %>%
  select(c(1:2,34:64)) %>%
  pivot_longer(cols = "1990":"2020", names_to = "Year", values_to = "Male Life Expectancy")

lifeexp <- left_join(wb_tot_lifeexp_long, wb_f_lifeexp_long, by = c("Country Name", "Country Code", "Year"))

lifeexp <- left_join(lifeexp, wb_m_lifeexp_long, by = c("Country Name", "Country Code", "Year"))
```

```{r edit_misc_data, warning = FALSE, echo = FALSE}
yrs <- c(2011:2020)

colnames(misc_data) <- c("Country Name", "Country Code", "Series Name", yrs)
misc_temp <- misc_data %>%
  pivot_longer(cols = 4:13, names_to = "Year", values_to = "Value")
misc_temp2 <- misc_temp %>%
  group_by("Country Name") %>%
  pivot_wider(names_from = "Series Name", values_from = "Value") %>%
  ungroup()
misc_temp3 <- select(misc_temp2, -4, -18)
misc_data2 <- misc_temp3[-c(2171:2610),]
j <- c(4:16)
misc_data2[j] <- lapply(misc_data2[j], unlist)
misc_data2[j] <- lapply(misc_data2[j], as.numeric)
```

```{r edit_h_spend, warning = FALSE, echo=FALSE}
h_spend2 <- select(h_spend, -1, -4)[-c(4897:5232),]
h_spend2 <- h_spend2 %>%
   mutate(location_name = case_when(
       location_name == "United States of America" ~ "United States",
       TRUE ~ location_name))
colnames(h_spend2)[1:3] <- c("Country Name", "Country Code", "Year")
```

```{r combine_data, warning = FALSE, echo=FALSE}
full_data <- full_join(lifeexp, misc_data2, by = c("Country Name", "Country Code", "Year"))
full_data$Year = as.double(full_data$Year)
full_data <- full_join(full_data, h_spend2, by = c("Country Name", "Country Code", "Year"))
full_data$`Total Life Expectancy` = as.numeric(full_data$`Total Life Expectancy`)
```

# Background
Numerous studies have analyzed the correlation between health spending and health outcomes, consistently finding a positive relationship between the two [1]. Other studies have investigated how GDP and educational attainment are associated with health outcomes and found that both are positive predictors of health [2]. Our study looks to build on past findings and conduct a multivariate analysis to better inform global leaders on focus areas for improving global health.

Like similar studies, we have chosen to analyze life expectancy and under-5 mortality rate as measures of health [1]. Period life expectancy at birth is often used as a measure of the overall health of a population. It is derived from the probabilities of people of certain age groups dying given the mortality rates of those age groups over a specific time frame. The probabilities are then used in a survival function to project the average age of death of a newborn of that time period [3]. Meanwhile, under-5 mortality rate reflects the probability of a child born in the year in question dying before the age of 5. It is represented as the number of predicted deaths per 1,000 live births [4].

# Research Question
This analysis aims to determine the significance of relationships between a set of World Development Indicators and health outcomes, measured by life expectancy and under-5 mortality rate.

# Data
We are combining health spending data from the Global Health Data Exchange [5] and world economic/health-related data from the World Bank [6], ranging from 1990-2020. For these data sets, we will be analyzing data from the 204 countries and territories that are included in both databases. The health spending data was collected from a wide variety of sources that included program reports, budget data, national estimates, and National Health Accounts (NHAs). The variables that we are most concerned with are location ID, location name, year, and total health expenditure (THE) per capita in purchasing power parity (PPP) dollars (2020 USD). Purchasing power parity accounts for the differences in economic and standards of living between countries. The World Bank collects data through various sources, mostly through national statistical systems of member countries. The variables that we are most concerned with are country or area, total life expectancy at birth (years), male life expectancy at birth (years), female life expectancy at birth (years), GDP (current US dollars), GDP growth (annual %), income share held by lowest 20%, mortality rate under 5 (per 1,000 live births), poverty headcount ratio at national poverty lines (% of population), and educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative) [6].

# Data Wrangling and Transformations
The two data sets were modified such that the observations could be merged by country name and year. No observations were removed at this stage for missing data. Additionally, many of the measures included in the Global Health Data Exchange data set were not used but were not removed in case future analysis involved those measures. \

Since the analysis plan involved regression models, we looked at the distribution of our outcome variables, life expectancy and under-5 mortality rate. The life expectancy data looked approximately normal. However, the mortality rate data was log-transformed to produce a more normal distribution:
```{r outcome-histo, warning = FALSE, echo=FALSE, fig.height = 2}
p_lifeexp <- full_data %>%
  ggplot(aes(full_data$'Total Life Expectancy')) + 
  geom_histogram(fill = "blue", na.rm = TRUE, bins = 50) + 
  labs(
    x = "Life Expectancy (Years)",
    y = "Frequency",
    title = "Distribution of Life Expectancy"
  ) 

p_mort <- full_data %>%
  ggplot(aes(full_data$`Mortality rate, under-5 (per 1,000 live births)`)) + 
  geom_histogram(fill = "blue", na.rm = TRUE, bins = 50) + 
  labs(
    x = "Mortality Rate (per 1,000 Live Births)",
    y = "Frequency",
    title = "Mortality Rate"
  )

p_log_mort <- full_data %>%
  ggplot(aes(log(full_data$`Mortality rate, under-5 (per 1,000 live births)`))) + 
  geom_histogram(fill = "aquamarine", na.rm = TRUE, bins = 50) + 
  labs(
    x = "Mortality Rate (Log per 1,000 Live Births)",
    y = "Frequency",
    title = "Distribution of Mortality Rate"
  )
grid.arrange(grobs = list(p_lifeexp, p_log_mort), ncol = 2, top = "Outcome Variable Distributions")
```

We then created visualizations of the predictor variables. Most were evenly distributed and generally resembled a normal distribution. However, THE and GDP were heavily skewed right. We found that applying a log transformation to both variables improved the results of our model.

```{r healtcarespendinghisto, warning = FALSE, echo=FALSE, fig.height = 4}
p_the <- full_data %>%
  ggplot(aes(x = the_per_cap_ppp_mean)) + 
  geom_histogram(fill = "red", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Mean Total Health Spending per Person (in PPP dollars)",
    y = "Frequency",
    title = "Distribution of Health Care Spending"
  )

p_log_the <- full_data %>%
  ggplot(aes(x = log(the_per_cap_ppp_mean))) + 
  geom_histogram(fill = "red", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Log Mean THE per Capita (Log PPP dollars)",
    y = "Frequency",
    title = "Health Care Spending"
  ) +
  theme(title = element_text(size = 10),
        axis.title.x = element_text(size = 6),
        axis.title.y = element_text(size = 8))

p_log_pov <- full_data %>%
  ggplot(aes(log(full_data$`Poverty headcount ratio at national poverty lines (% of population)`))) + 
  geom_histogram(fill = "blue", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Log Poverty Headcount Ratio",
    y = "Frequency",
    title = "Poverty Headcount"
  )

p_pov <- full_data %>%
  ggplot(aes(full_data$`Poverty headcount ratio at national poverty lines (% of population)`)) + 
  geom_histogram(fill = "maroon1", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Poverty Headcount Ratio",
    y = "Frequency",
    title = "Poverty Headcount"
  ) +
  theme(axis.title.y = element_text(size = 8))

p_log_gdp <- full_data %>%
  ggplot(aes(log(full_data$`GDP per capita (current US$)`))) + 
  geom_histogram(fill = "darkorange", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Log GDP",
    y = "Frequency",
    title = "GDP"
  ) +
  theme(axis.title.y = element_text(size = 8))

p_gdpg <- full_data %>%
  ggplot(aes(log(full_data$`GDP per capita growth (annual %)`))) + 
  geom_histogram(fill = "darkgoldenrod2", na.rm = TRUE, bins = 30) + 
  labs(
    x = "GDP Growth (Annual %)",
    y = "Frequency",
    title = "GDP Growth"
  ) +
  theme(axis.title.y = element_text(size = 8))

p_inc <- full_data %>%
  ggplot(aes(full_data$`Income share held by lowest 20%`)) + 
  geom_histogram(fill = "purple", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Income Share Held by Lowest 20%",
    y = "Frequency",
    title = "Income Share (%)"
  ) +
  theme(axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8))

p_edu <- ggplot(data = full_data, aes(full_data$`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`)) + 
  geom_histogram(fill = "yellow", na.rm = TRUE, bins = 30) + 
  labs(
    x = "Secondary Education Completion (%)",
    y = "Frequency",
    title = "Secondary Educational Attainment"
  ) +
  theme(title = element_text(size = 6),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8))

grid.arrange(grobs = list(p_log_the, p_log_gdp, p_gdpg, p_pov, p_inc, p_edu), ncol = 3, top = "Predictor Variable Distributions")
```

Then, we looked at healthcare spending over time in a few selected countries to see any trends in the data:

```{r healthspendinglinegraph, warning =FALSE, echo=FALSE, fig.height = 3, fig.width = 4}
full_data %>%
  filter(`Country Name` == "Australia" | `Country Name` == "United States of America" |  `Country Name` == "Canada" |  `Country Name` == "China" | `Country Name` == "Indonesia" | `Country Name` == "Russia" | `Country Name` == "Sudan") %>%
ggplot(aes(x=Year, y=log(the_per_cap_ppp_mean), group = `Country Name`)) +
  geom_line(aes(linetype= `Country Name`))+
  geom_point(aes(shape=`Country Name`)) +
 labs( 
   title = "Health Spending Around the World Over Time",
       y = "Log of Mean total health spending per person (in PPP dollars)")
```

We found that healthcare spending generally increased over time in developed countries and was also significantly larger in Western than Eastern countries. This would be confirmed when we mapped health care spending. While mapping, we also mapped what would later be one of our response variables: life expectancy. We wanted to visualize life expectancy across countries to see any geographic patterns:

```{r healthspending_and_lifeexpectancymap, warning =FALSE, echo=FALSE, fig.width=10, fig.height = 4}

world <- ne_countries(scale = "medium", returnclass = "sf")
full_data1 = full_data %>%
  filter(Year == 2015)
healthspending.world <- merge(world, full_data1, by.x="adm0_a3", by.y="Country Code")

map1 <- ggplot(data = healthspending.world) +
    geom_sf(aes(fill = log(the_per_cap_ppp_mean))) +
    scale_fill_viridis_c(option = "plasma") +
    labs(title = "Health Spending",
       fill = "Log(THE) (log 2020 USD)") +
    theme(legend.title = element_text(angle = 90, size = 6),
        legend.key.width = unit(2, 'mm'),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    guides(fill = guide_colorbar(title.position = "left"))


map2 <- ggplot(data = healthspending.world) +
    geom_sf(aes(fill = log(`Mortality rate, under-5 (per 1,000 live births)`))) +
    scale_fill_viridis_c(option = "plasma") +
    labs(title = "Mortality Rates",
       fill = "Log(Mortality Rates Under 5, per 1000)")  +
    theme(legend.title = element_text(angle = 90, size = 5),
        legend.key.width = unit(2, 'mm'),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    guides(fill = guide_colorbar(title.position = "left"))

map3 <- ggplot(data = healthspending.world) +
    geom_sf(aes(fill = `Total Life Expectancy`)) +
    scale_fill_viridis_c(option = "plasma") +
    labs(title = "Life Expectancies",
       fill = "Life Expectancy (Years)")  +
    theme(legend.title = element_text(angle = 90, size = 6),
        legend.key.width = unit(2, 'mm'),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    guides(fill = guide_colorbar(title.position = "left"))

grid.arrange(grobs = list(map1, map2, map3), ncol = 3)
```
We saw the same pattern as in the line charts where Western countries had higher healthcare spending,higher life expectancy, and lower mortality rates. The same trend was generally true for developed compared to non-developed regions. We also began to notice the problem of missingness in our dataset where mortality rates and life expectancies for some countries (most notably the U.S.) were absent.

Finally, we wanted to visualize the relationship between healthcare spending and our health outcomes (being mortality rates under 5 and life expectancy). We used scatterplots to do so:
```{r healthspending_vs_lifeeexpectancy, warning =FALSE, echo=FALSE, fig.height = 3}
full_data1 %>%
ggplot(aes(x = log(the_per_cap_ppp_mean), y = `Total Life Expectancy`)) + 
  geom_point(alpha = 0.6) +
labs( x= "Log of Mean THE per Capita (in PPP dollars)",
      y = "Total Life Expectancy",
      title = "Mean THE per Capita versus Life Expectancy")

full_data1 %>%
ggplot(aes(x = log(the_per_cap_ppp_mean), y = `Mortality rate, under-5 (per 1,000 live births)`)) + 
  geom_point(alpha = 0.6) +
labs( x= "Log of Mean THE per Capita (in PPP dollars)", y = "Mortality Rates Under 5")
```
There is a clear positive linear relationship between healthcare spending and life expectancy but a more exponential-decay trend in healthcare spending and mortality rates under 5. Viewing these trends would come in helpful when modelling. Within the descriptive statistics portion of our project, we also explored healthcare spending by GDP, distributions of mortality rates, life expectancies, and fertility rates, male vs. female life expectancy distributions, and line graphs of health outcomes over time. However, the most significant graphs and visualizations are included above as these helped the most in understanding our data set and fitting the proper models. In addition to this, some outcomes such as fertility rates were excluded after data visualization due the missingness in that variable being to great to deal with. 

# Modeling

In our models, we decided to explore two commonly used health outcome measures: life expectancy and mortality rate under the age of 5. For each health outcome, we constructed 3 different models: a simple linear model with all the covariates we had identified, a quadratic model with only the covariates that increased adjusted R^2, and a quadratic model with interaction effects using only the covariates that increased adjusted R^2. Adjusted R^2 and residual plots were used for assessing and selecting models. 

**Life Expectancy Simple Linear Model**

$\text{Total Life Expectancy} = \beta_0 + \beta_1*log(\text{THE}) + \beta_2*log(\text{GDP}) + \beta_3*\text{GDP Growth} + \beta_4*\text{Income Share} + \beta_5*\text{Poverty} + \beta_6*\text{Education}$ 

```{r full_life_expectancy_model_table, echo = FALSE}

full_data_life_exp <- full_data %>%
  filter(is.na(`Total Life Expectancy`) == FALSE) %>%
  filter(`Total Life Expectancy` != '..') %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  filter(is.na(`GDP (current US$)`) == FALSE) %>%
  filter(is.na(`GDP growth (annual %)`) == FALSE) %>%
  filter(is.na(`Income share held by lowest 20%`) == FALSE) %>%
  filter(is.na(`Poverty headcount ratio at national poverty lines (% of population)`) == FALSE) %>%
  filter(is.na(`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`) == FALSE)

lifeexp_fullfit <- linear_reg() %>%
 set_engine("lm") %>%
fit(`Total Life Expectancy` ~ log(the_per_cap_ppp_mean) +  log(`GDP (current US$)`) +`GDP growth (annual %)` + `Income share held by lowest 20%` + `Poverty headcount ratio at national poverty lines (% of population)` + `Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`, data = full_data_life_exp)
```

``` {r table1}
result1 <- tidy(lifeexp_fullfit, conf.int=TRUE)
vals1 <- c("$\\beta_0$", "$\\beta_1$", "$\\beta_2$", "$\\beta_3$", "$\\beta_4$", "$\\beta_5$", "$\\beta_6$")
result1 <- result1[-c(1, 3:4)]
result1 <- t(result1)
colnames(result1) <- vals1
rownames(result1) <- c("Value", "p-value", "CI Lower", "CI Higher")
result1 %>% kable(escape = FALSE,
                  digits = 4) %>%
  kable_classic(full_width = F, html_font = "helvetica") %>%
  kable_styling(latex_options = "hold_position",
                font_size = 12)
```

``` {r full_life_expectancy_model_r2, include = FALSE}
glance(lifeexp_fullfit)$r.squared
glance(lifeexp_fullfit)$adj.r.squared
```

The R$^2$ for the life expectancy simple linear model is 0.8387499 which means that 0.8387499 of the variation in life expectancy is explained by the model. The adjusted R$^2$ for the life expectancy simple linear model is 0.8337108 which means that 0.8337108 of the variation in life expectancy is explained by the model, adjusting for the number of variables included. 

``` {r full_life_expectancy_model_resid, warning = FALSE, echo = FALSE, fig.height = 3}
lifeexp_fullfit_aug <- augment(lifeexp_fullfit$fit)

ggplot(lifeexp_fullfit_aug, mapping = aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Life Expectancy Simple Linear Model Residual Plot", x = "Predicted Total Life Expectancy (years)", y = "Residuals")  +
  theme(title = element_text(size = 8))
```
This residual scatter plot is concerning because the points in the plot appear to decrease for higher predicted life expectancies and thus are not randomly and evenly distributed around 0. There is also some clustering of the residual points occurring around 82.5 years in predicted total life expectancy. 

**Life Expectancy Quadratic Model**

$\text{Total Life Expectancy} = \beta_0 + \beta_1*log(\text{THE}) + \beta_2*log(\text{THE})^2 + \beta_3*log(\text{GDP}) + \beta_4*\text{Poverty} + \beta_5*\text{Education} + \beta_6*\text{Education}^2$ 

```{r sig_life_expectancy_model_table, include = FALSE}
sig_data_life_exp <- full_data %>%
  filter(is.na(`Total Life Expectancy`) == FALSE) %>%
  filter(`Total Life Expectancy` != '..') %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  filter(is.na(`GDP (current US$)`) == FALSE) %>%
  filter(is.na(`Poverty headcount ratio at national poverty lines (% of population)`) == FALSE) %>%
  filter(is.na(`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`) == FALSE) %>%
  
  mutate(spending = log(the_per_cap_ppp_mean)) %>%
  mutate(gdp = log(`GDP (current US$)`)) %>%
  mutate(poverty = `Poverty headcount ratio at national poverty lines (% of population)`) %>%
  mutate(education = `Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`)

sig_data_life_exp$spending2 <- sig_data_life_exp$spending^2
sig_data_life_exp$education2 <- sig_data_life_exp$education^2

lifeexp_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(`Total Life Expectancy` ~  
        spending 
      + spending2 
      + gdp
      + poverty
      + education 
      + education2
      ,data = sig_data_life_exp)
```

``` {r table2}
result2 <- tidy(lifeexp_fit, conf.int=TRUE)
vals2 <- c("$\\beta_0$", "$\\beta_1$", "$\\beta_2$", "$\\beta_3$", "$\\beta_4$", "$\\beta_5$", "$\\beta_6$")
result2 <- result2[-c(1, 3:4)]
result2 <- t(result2)
colnames(result2) <- vals2
rownames(result2) <- c("Value", "p-value", "CI Lower", "CI Higher")
result2 %>% kable(escape = FALSE,
                  digits = 4) %>%
  kable_classic(full_width = F, html_font = "helvetica") %>%
  kable_styling(latex_options = "hold_position",
                font_size = 12)
```

```{r sig_life_expectancy_model_table_r2, include = FALSE}
glance(lifeexp_fit)$r.squared
glance(lifeexp_fit)$adj.r.squared
```

The R$^2$ for the life expectancy quadratic model is 0.8997453 which means that 0.8997453 of the variation in life expectancy is explained by the model. The adjusted R$^2$ for the life expectancy quadratic model is 0.896811 which means that 0.896811 of the variation in life expectancy is explained by the model, adjusting for the number of variables included. The higher adjusted R$^2$ of this quadratic model indicates that it is a better model than the simple linear model. 

```{r sig_life_expectancy_model_table_resid, warning = FALSE, echo = FALSE, fig.height = 3}
lifeexp_fit_aug <- augment(lifeexp_fit$fit)

ggplot(lifeexp_fit_aug, mapping = aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Life Expectancy Quadratic Model Residual Plot", x = "Predicted Total Life Expectancy (years)", y = "Residuals")  +
  theme(title = element_text(size = 8))
```

This residual scatter plot is an improvement from the linear model as the points are more randomly and evenly distributed around 0, and there is less correlation between predicted value and residual. The residual points also seem to be more tightly centered/closer to 0. However, there still appears to be clustering around 82.5 predicted years as well as around 77.5 predicted years.

**Life Expectancy Quadratic Interaction Model**

$\text{Total Life Expectancy} = \beta_0 + \beta_1*log(\text{THE}) + \beta_2*log(\text{THE})^2 + \beta_3*log(\text{GDP}) + \beta_4*\text{Poverty} + \beta_5*\text{Education} + \beta_6*\text{Education}^2 + \beta_7*\text{GDP Growth} + \beta_8*\text{Poverty}*\text{Education} + \beta_9*\text{GDP Growth}*\text{Education} + \beta_{10}*\text{Poverty}*\text{GDP} + \beta_{11}*\text{GDP}*\text{Education} + \beta_{12}*log(\text{THE})*\text{Poverty}$ 

```{r mixed_life_expectancy_model_table, include = FALSE}
mixed_data_life_exp <- full_data %>%
  filter(is.na(`Total Life Expectancy`) == FALSE) %>%
  filter(`Total Life Expectancy` != '..') %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  filter(is.na(`GDP (current US$)`) == FALSE) %>%
  filter(is.na(`GDP growth (annual %)`) == FALSE) %>%
  filter(is.na(`Poverty headcount ratio at national poverty lines (% of population)`) == FALSE) %>%
  filter(is.na(`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`) == FALSE) %>%
  
  mutate(spending = log(the_per_cap_ppp_mean)) %>%
  mutate(gdp = log(`GDP (current US$)`)) %>%
  mutate(gdpg = `GDP growth (annual %)`) %>%
  mutate(poverty = `Poverty headcount ratio at national poverty lines (% of population)`) %>%
  mutate(education = `Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`)

mixed_data_life_exp$spending2 <- mixed_data_life_exp$spending^2
mixed_data_life_exp$education2 <- mixed_data_life_exp$education^2

lifeexp_mixedfit<- linear_reg() %>%
  set_engine("lm") %>%
  fit(`Total Life Expectancy` ~  
        spending 
      + spending2 
      + gdp
      + poverty
      + education 
      + education2
      + poverty*education
      + gdpg*education
      + gdp*poverty
      + gdp*education
      + spending*poverty
      ,data = mixed_data_life_exp)

tidy(lifeexp_mixedfit, conf.int=TRUE)
```

``` {r table3}
result3 <- tidy(lifeexp_mixedfit, conf.int=TRUE)
vals3 <- c("$\\beta_0$", "$\\beta_1$", "$\\beta_2$", "$\\beta_3$", "$\\beta_4$", "$\\beta_5$", "$\\beta_6$", "$\\beta_7$", "$\\beta_8$", "$\\beta_9$", "$\\beta_{10}$", "$\\beta_{11}$", "$\\beta_{12}$")
result3 <- result3[-c(1, 3:4)]
result3 <- t(result3)
colnames(result3) <- vals3
rownames(result3) <- c("Value", "p-value", "CI Lower", "CI Higher")
result3 %>% kable(escape = FALSE,
                  digits = 4) %>%
  kable_classic(full_width = F, html_font = "helvetica") %>%
  kable_styling(latex_options = c("hold_position","scale_down"),
                font_size = 8)
```

From this model, of the significant and interpretable coefficients, we see that for every percent of the population that has completed at least secondary education, we expect to see life expectancy to be higher by 0.46 on average.

```{r mixed_life_expectancy_model_r2, include = FALSE}
glance(lifeexp_mixedfit)$r.squared
glance(lifeexp_mixedfit)$adj.r.squared
```

The R$^2$ for the life expectancy quadratic interaction model is 0.9203884 which means that 0.9203884 of the variation in life expectancy is explained by the model. The adjusted R$^2$ for the life expectancy quadratic interaction model is 0.9155877 which means that 0.9155877 of the variation in life expectancy is explained by the model, adjusting for the number of variables included. The higher adjusted R^2 of this quadratic interaction model indicates that it is a better model than the simple linear model and quadratic model. 

```{r mixed_life_expectancy_model_resid, warning = FALSE, echo = FALSE, fig.height = 3}
lifeexp_mixedfit_aug <- augment(lifeexp_mixedfit$fit)

ggplot(lifeexp_mixedfit_aug, mapping = aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Life Expectancy Quadratic Interaction Model Residual Plot", x = "Predicted Total Life Expectancy (years)", y = "Residuals")  +
  theme(title = element_text(size = 8))
```

This residual scatter plot is an improvement from the quadratic model as the points are appear to less clustered and thus are more evenly distributed across the predicted years. However, the residual points seem to be less tightly centered/close to 0.

**Mortality Rate Under the Age of 5 Simple Linear Model**

$log(\text{Under-5 Mortality} = \beta_0 + \beta_1*log(\text{THE}) + \beta_2*log(\text{GDP}) + \beta_3*\text{GDP Growth} + \beta_4*\text{Income Share} + \beta_5*\text{Poverty} + \beta_6*\text{Education}$ 

```{r full_mortality_model_table, include = FALSE}
full_data_mortality <- full_data %>%
  filter(is.na(`Mortality rate, under-5 (per 1,000 live births)`) == FALSE) %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  filter(is.na(`GDP (current US$)`) == FALSE) %>%
  filter(is.na(`GDP growth (annual %)`) == FALSE) %>%
  filter(is.na(`Income share held by lowest 20%`) == FALSE) %>%
  filter(is.na(`Poverty headcount ratio at national poverty lines (% of population)`) == FALSE) %>%
  filter(is.na(`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`) == FALSE)
  
mortality_fullfit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(log(`Mortality rate, under-5 (per 1,000 live births)`) ~ log(the_per_cap_ppp_mean) + log(`GDP (current US$)`) + `GDP growth (annual %)` + `Income share held by lowest 20%` + `Poverty headcount ratio at national poverty lines (% of population)` + `Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`, data = full_data_mortality)

tidy(mortality_fullfit, conf.int=TRUE)
```

``` {r table4}
result4 <- tidy(mortality_fullfit, conf.int=TRUE)
vals4 <- c("$\\beta_0$", "$\\beta_1$", "$\\beta_2$", "$\\beta_3$", "$\\beta_4$", "$\\beta_5$", "$\\beta_6$")
result4 <- result4[-c(1, 3:4)]
result4 <- t(result4)
colnames(result4) <- vals4
rownames(result4) <- c("Value", "p-value", "CI Lower", "CI Higher")
result4 %>% kable(escape = FALSE,
                  digits = 4) %>%
  kable_classic(full_width = F, html_font = "helvetica") %>%
  kable_styling(latex_options = "hold_position",
                font_size = 12)
```

```{r full_mortality_model_r2, include = FALSE}
glance(mortality_fullfit)$r.squared
glance(mortality_fullfit)$adj.r.squared
```

The R$^2$ for the mortality rate under the age of 5 simple linear model is 0.8513467 which means that 0.8513467 of the variation in mortality rate is explained by the model. The adjusted R$^2$ for the mortality rate under the age of 5 simple linear model is 0.8467013 which means that 0.8467013 of the variation in mortality rate is explained by the model, adjusting for the number of variables included.

```{r full_mortality_model_resid, warning = FALSE, echo = FALSE, fig.height = 3}
mortality_fullfit_aug <- augment(mortality_fullfit$fit)

ggplot(mortality_fullfit_aug, mapping = aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Mortality Rate Under the Age of 5 Simple Linear Model Residual Plot", x = "Predicted Mortality Rate, under-5 (per 1,000 live births)", y = "Residuals")  +
  theme(title = element_text(size = 8))
```

This residual scatter plot is satisfactory because the points in the plot appear to be evenly and randomly distributed around 0. 

**Mortality Rate Under the Age of 5 Quadratic Model**

$log(\text{Under-5 Mortality}) = \beta_0 + \beta_1*log(\text{THE}) + \beta_2*log(\text{THE})^2 + \beta_3*log(\text{GDP}) + \beta_4*log(\text{GDP})^2 + \beta_5*\text{Income share} + \beta_6*\text{Income share}^2 + \beta_7*\text{Poverty}^2 + \beta_8*\text{Education} + \beta_9*\text{Education}^2$

```{r sig_mortality_model_table, include = FALSE}
sig_data_mortality <- full_data %>%
  filter(is.na(`Mortality rate, under-5 (per 1,000 live births)`) == FALSE) %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  filter(is.na(`GDP (current US$)`) == FALSE) %>%
  filter(is.na(`Income share held by lowest 20%`) == FALSE) %>%
  filter(is.na(`Poverty headcount ratio at national poverty lines (% of population)`) == FALSE) %>%
  filter(is.na(`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`) == FALSE) %>%
  
  mutate(mortality = log(`Mortality rate, under-5 (per 1,000 live births)`)) %>%
  mutate(spending = log(the_per_cap_ppp_mean)) %>%
  mutate(gdp = log(`GDP (current US$)`)) %>%
  mutate(income = `Income share held by lowest 20%`) %>%
  mutate(poverty = `Poverty headcount ratio at national poverty lines (% of population)`) %>%
  mutate(education = `Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`)

sig_data_mortality$spending2 <- sig_data_mortality$spending^2
sig_data_mortality$gdp2 <- sig_data_mortality$gdp^2
sig_data_mortality$income2 <- sig_data_mortality$income^2
sig_data_mortality$poverty2 <- sig_data_mortality$poverty^2
sig_data_mortality$education2 <- sig_data_mortality$education^2

mortality_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(mortality ~  spending 
      + spending2
      + gdp
      + gdp2
      + income
      + income2
      + poverty2
      + education
      + education2
      ,data = sig_data_mortality)

tidy(mortality_fit, conf.int=TRUE)
```

``` {r table5}
result5 <- tidy(mortality_fit, conf.int=TRUE)
vals5 <- c("$\\beta_0$", "$\\beta_1$", "$\\beta_2$", "$\\beta_3$", "$\\beta_4$", "$\\beta_5$", "$\\beta_6$", "$\\beta_7$", "$\\beta_8$", "$\\beta_9$")
result5 <- result5[-c(1, 3:4)]
result5 <- t(result5)
colnames(result5) <- vals5
rownames(result5) <- c("Value", "p-value", "CI Lower", "CI Higher")
result5 %>% kable(escape = FALSE,
                  digits = 4) %>%
  kable_styling(latex_options = "hold_position",
                font_size = 9) %>%
  kable_classic(full_width = F, html_font = "helvetica")

```

```{r sig_mortality_model_r2, include = FALSE}
glance(mortality_fit)$r.squared
glance(mortality_fit)$adj.r.squared
```

The R$^2$ for the mortality rate under the age of 5 quadratic model is 0.8789936 which means that 0.8789936 of the variation in mortality rate is explained by the model. The adjusted R$^2$ for the mortality rate under the age of 5 quadratic model is 0.8732314 which means that 0.8732314 of the variation in mortality rate is explained by the model, adjusting for the number of variables included. The higher adjusted R$^2$ of this quadratic model indicates that it is a better model than the simple linear model. 

```{r sig_mortality_model_resid, warning = FALSE, echo = FALSE, fig.height = 3}
mortality_fit_aug <- augment(mortality_fit$fit)

ggplot(mortality_fit_aug, mapping = aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Mortality Rate Under-5 Quadratic Model Residual Plot", x = "Predicted Mortality Rate, under-5 (per 1,000 live births)", y = "Residuals") +
  theme(title = element_text(size = 8))
```

This residual scatter plot is slightly worse than that for the linear model. There appear to be more negative residuals at lower predicted rates and more positive residuals at the middle predicted rates. Overall, the residuals are generally randomly and evenly distributed around 0.

**Mortality Rate Under the Age of 5 Quadratic Interaction Model**

$log(\text{Under-5 Mortality}) = \beta_0 + \beta_1*log(\text{THE}) + \beta_2*log(\text{THE})^2 + \beta_3*log(\text{GDP}) + \beta_4*log(\text{GDP})^2 + \beta_5*\text{Income} + \beta_6*\text{Income}^2 + \beta_7*\text{Poverty}^2 + \beta_8*\text{Education} + \beta_9*\text{Education}^2 + \beta_{10}*\text{GDP Growth} + \beta_{11}*\text{Poverty} + \beta_{12}*\text{Income}*\text{Education} + \beta_{13}*log(\text{THE})*log(\text{GDP}) + \beta_{14}*\text{Income}*\text{GDP Growth} + \beta_{15}*\text{Education}*\text{GDP Growth} + \beta_{16}*log(\text{GDP})*\text{Education} + \beta_{17}*log(\text{GDP})*\text{Income} + \beta_{18}*\text{Income}*\text{Poverty}$ 

For this model, of the significant and interpretable coefficients, as the percent of the population with post-secondary education increased by 1 percent, we would expect the mortaly rate under the age of 5 to decrease by 0.11, on average. In addition to that, as poverty head count ratio increases by one, we expect the mortality rate under the age of 5 to decrease by 0.0796. 

```{r mixed_mortality_model_table, include = FALSE}
mixed_data_mortality <- full_data %>%
  filter(is.na(`Mortality rate, under-5 (per 1,000 live births)`) == FALSE) %>%
  filter(is.na(the_per_cap_ppp_mean) == FALSE) %>%
  filter(is.na(`GDP (current US$)`) == FALSE) %>%
  filter(is.na(`GDP growth (annual %)`) == FALSE) %>%
  filter(is.na(`Income share held by lowest 20%`) == FALSE) %>%
  filter(is.na(`Poverty headcount ratio at national poverty lines (% of population)`) == FALSE) %>%
  filter(is.na(`Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`) == FALSE) %>%
  
  mutate(mortality = log(`Mortality rate, under-5 (per 1,000 live births)`)) %>%
  mutate(spending = log(the_per_cap_ppp_mean)) %>%
  mutate(gdp = log(`GDP (current US$)`)) %>%
  mutate(gdpg = `GDP (current US$)`) %>%
  mutate(income = `Income share held by lowest 20%`) %>%
  mutate(poverty = `Poverty headcount ratio at national poverty lines (% of population)`) %>%
  mutate(education = `Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative)`)

mixed_data_mortality$spending2 <- mixed_data_mortality$spending^2
mixed_data_mortality$gdp2 <- mixed_data_mortality$gdp^2
mixed_data_mortality$income2 <- mixed_data_mortality$income^2
mixed_data_mortality$poverty2 <- mixed_data_mortality$poverty^2
mixed_data_mortality$education2 <- mixed_data_mortality$education^2

mortality_mixedfit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(mortality ~  spending 
      + spending2
      + gdp
      + gdp2
      + income
      + income2
      + poverty2
      + education
      + education2
      + income*education
      + spending*gdp
      + gdpg*income
      + gdpg*education
      + gdp*education
      + gdp*income
      + income*poverty
      ,data = mixed_data_mortality)

tidy(mortality_mixedfit, conf.int=TRUE)
```

``` {r table6}
result6 <- tidy(mortality_mixedfit, conf.int=TRUE)
vals6 <- c("$\\beta_0$", "$\\beta_1$", "$\\beta_2$", "$\\beta_3$", "$\\beta_4$", "$\\beta_5$", "$\\beta_6$", "$\\beta_7$", "$\\beta_8$", "$\\beta_9$", "$\\beta_{10}$", "$\\beta_{11}$", "$\\beta_{12}$", "$\\beta_{13}$", "$\\beta_{14}$", "$\\beta_{15}$", "$\\beta_{16}$", "$\\beta_{17}$", "$\\beta_{18}$")
result6 <- result6[-c(1, 3:4)]
result6 <- t(result6)
colnames(result6) <- vals6
rownames(result6) <- c("Value", "p-value", "CI Lower", "CI Higher")
knitr::kable(result6,
             escape = FALSE,
             digits = 3) %>%
  kable_styling(latex_options = c("hold_position","scale_down"),
                font_size = 8) %>%
  kable_classic(html_font = "helvetica")
```

```{r mixed_mortality_model_r2, include = FALSE}
glance(mortality_mixedfit)$r.squared
glance(mortality_mixedfit)$adj.r.squared
```

The R$^2$ for the mortality rate under the age of 5 quadratic interaction model is 0.9123402 which means that 0.9123402 of the variation in mortality rate is explained by the model. The adjusted R$^2$ for the mortality rate under the age of 5 quadratic interaction model is 0.9035743 which means that 0.9035743 of the variation in mortality rate is explained by the model, adjusting for the number of variables included. The higher adjusted R$^2$ of this quadratic interaction model indicates that it is a better model than the simple linear model and quadratic model. 

```{r mixed_mortality_model_resid, warning = FALSE, echo = FALSE, fig.height = 3}
mortality_mixedfit_aug <- augment(mortality_mixedfit$fit)

ggplot(mortality_mixedfit_aug, mapping = aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Mortality Rate Under the Age of 5 Quadratic Interaction Model Residual Plot", x = "Predicted Mortality Rate, under-5 (per 1,000 live births)", y = "Residuals")  +
  theme(title = element_text(size = 8))
```

This residual scatter plot is an improvement from the quadratic model as the points are appear to less clustered and thus are more evenly distributed across predicted mortality rates. The curvy shape of the residual points is also less prominent in this plot. However, the points seem to be less tightly centered/close to 0.

# Conclusions
Comparing the two final models, we see one major similarity arise, whether we use mortality rates under 5 or life expectancy. As the percent of the population that has post-secondary education increases, health outcomes are expected to improve, on average. Therefore, the most significant and consistent conclusion we can take away is that there appears to be an association between educational levels in a country and their health outcomes. 

# Limitations
One limitation in our models is that although some of the interaction terms and normalized variables improved the models, their coefficients proved to be uninterpretable. In addition to that, the residual plot for the Life Expectancy Quadratic Interaction Model which we used for analysis had some clustering which was not ideal. The clustering was not extreme and the R^2 was high enough to justify use of the model. 

# References
 [1] Gallet CA, Doucouliagos H. The impact of healthcare spending on health outcomes: A meta-regression analysis. Soc Sci Med. 2017 Apr;179:9-17. doi: 10.1016/j.socscimed.2017.02.024. Epub 2017 Feb 20. PMID: 28237460.
 
 [2] Lutz, Wolfgang and Endale Kebede. "Education and Health: Redrawing the Preston Curve." Population and Development Review, vol. 44, no. 2, 2018, pp. 343-61, doi:https://doi.org/10.1111/padr.12141.

 [3] Luy, Marc et al. "Life Expectancy: Frequently Used, but Hardly Understood." Gerontology, vol. 66, no. 1, 2019, pp. 95-104, https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7026938/.
 
 [4] "Under-Five Mortality Rate (Probability of Dying by Age 5 Per 1000 Live Births)." Indicator Metadata Registry List. World Health Organization https://www.who.int/data/gho/indicator-metadata-registry/imr-details/7.
 
 [5] [1] Global Burden of Disease Collaborative Network. Global Health Spending 1995-2018. Seattle, United States of America: Institute for Health Metrics and Evaluation (IHME), 2021. \
 
 [6] World Bank. World Development Indicators, The World Bank Group, 2021,
https://databank.worldbank.org/source/world-development-indicators